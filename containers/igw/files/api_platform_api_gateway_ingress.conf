#
# This config matches host names xxx.zzz.tax.service.gov.uk
#   (where xxx = a microservice name, zzz = the environment)
# It then translates the host into xxx.protected.mdtp
#
# This is temporary to workaround an issue with AWS API Gateway that doesn't allow private host names
# See https://jira.tools.tax.service.gov.uk/browse/API-3735
#

server {
    listen 10000;

    server_name ~^(?<name>.+)\.(?<environment>.+)\.tax\.service\.gov\.uk$;

    access_log /var/log/nginx/access.log json_log_format buffer=_BUFFER flush=_FLUSH;

    client_max_body_size       100m;
    client_body_buffer_size    128k;

    proxy_set_header           Host $name.protected.mdtp;
    proxy_set_header           X-Real-IP   $remote_addr;
    proxy_set_header           X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header           X-Forwarded-Proto  $http_x_forwarded_proto;
    proxy_set_header           X-Forwarded-Server  $http_x_forwarded_server;
    proxy_set_header           X-Forwarded-Host  $http_x_forwarded_host;
    proxy_set_header           X-Forwarded-Port  $http_x_forwarded_port;

    proxy_connect_timeout      5;
    proxy_send_timeout         45;
    proxy_read_timeout         60;

    proxy_buffer_size          8k;
    proxy_buffers              4 32k;
    proxy_busy_buffers_size    64k;
    proxy_temp_file_write_size 64k;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Hide the nginx version number from the Server heading
    server_tokens off;

    # Remove 'nginx' server header
    #more_set_headers Server;

    location / {
        proxy_pass            http://application_in_task;
        proxy_next_upstream   off;
    }
}
